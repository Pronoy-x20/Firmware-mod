!function(l){l.su.moduleManager.define("firmware",{models:["firmwareSetModel","onlineUpgradeModel","statusAll","autoUpgradeModel","timeSettings"],stores:["upgradeLogStore","autoUpdateTimeStore"],deps:["main","quickSetup"],services:["ajax","language","vtype","time","moduleManager","device"],views:["firmwareView","firmwareQsView"],listeners:{"ev_on_launch":function(e,a,o,n,r,t,i){if(i.device.getConfig().supportAutoUpdate){i.time.on("on_time_change",a.onTimeChange);for(var s=[],c=0;c<11;c++)s.push({name:c+":00AM to "+(c+2)+":00AM",value:c});s.push({name:"11:00AM to 1:00PM",value:11});for(c=0;c<11;c++)s.push({name:c+":00PM to "+(c+2)+":00PM",value:c+12});s.push({name:"11:00PM to 1:00AM",value:23}),r.autoUpdateTimeStore.loadData(s),n.autoUpgradeModel.load(),o.firmwareView.autoUpdateWrap.hide()}n.timeSettings.load({success:function(e){a.timeType=e.type}}),o.firmwareView.upgradeOption.hide(),n.firmwareSetModel.load({success:function(){var e=n.firmwareSetModel.getData();a.rebootTime=parseInt(1e3*e.totalTime||a.rebootTime,10);var r=e.hardwareVersion;i.device.getConfig().supportFirmwareInfoReplace&&(r=r.replace("v1.0","v1.0/v1.20")),o.firmwareView.hardwareVersion.setValue(r)}}),n.onlineUpgradeModel.load(),n.statusAll.load({success:function(){var e=n.statusAll.getData(),r=e.wireless2gEnable,a=e.wireless5gEnable,t=e.wireless5g2Enable;"on"===r?o.firmwareView.reconnect2g.show():o.firmwareView.reconnect2g.hide(),"on"===a?o.firmwareView.reconnect5g1.show():o.firmwareView.reconnect5g1.hide(),"on"===t?o.firmwareView.reconnect5g2.show():o.firmwareView.reconnect5g2.hide()}}),i.ajax.request({proxy:"checkWireTypeProxy",success:function(e){a.wireType=e.wire_type}}),a.setMode(null),"ap"!==i.device.getCurrentMode()&&i.device.getConfig().supportAutoUpdate||o.firmwareView.autoUpdateField.hide()},"ev_before_destroy":function(){this.beforeDestroy()}},init:function(o,n,a,t,e,i){this.configViews({}),this.listen({"models.onlineUpgradeModel":{"ev_loaded":function(){var e=a.onlineUpgradeModel.getData();n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.checkUpgradesBtn.hide(),e.latestFlag?(n.firmwareView.upgradeOption.hide(),n.firmwareView.checkUpgradesBtn.show(),n.firmwareView.checkUpgradesBtn.setTips(l.su.CHAR.FIRMWARE.FIRMWARE_UPTO_DATE)):(n.firmwareView.checkUpgradesBtn.hide(),n.firmwareView.checkUpgradesBtn.setTips(),n.firmwareView.upgradeOption.show(),i.ajax.request({proxy:"checkUpgradeNumberProxy",success:function(e){parseInt(e.updateNumber,10)}}))}},"models.onlineUpgradeModel.detail":{"ev_value_change":function(e,r){var a=r.replace(/\\t/g," ");a=a.replace(/\\'/g,"'"),t.upgradeLogStore.loadData(a.split("\\n"),!0)}},"models.autoUpgradeModel.enable":{"ev_value_change":function(e,r){"on"==r?n.firmwareView.autoUpdateWrap.show():n.firmwareView.autoUpdateWrap.hide()}}}),this.control({"#firmware-check-upgrades-btn":{"ev_button_click":function(){o.startCheckUpgrade()}},"#firmware-whats-new":{"ev_button_click":function(){t.upgradeLogStore.toggle()}},"#online-upgrade-btn":{"ev_button_click":function(){o.modeFlag="online",n.firmwareView.confirmUpgrade.show()}},"#manual-upgrade-file":{"ev_file_change":function(e,r){var a=this.checkFileName(r,"bin"),t=n.firmwareView.firmwareFile;!0===a?t.setNormal():t.setError(a)}},"#local-upgrade-btn":{"ev_button_click":function(){o.modeFlag="manual";var e=n.firmwareView.firmwareFile,r=e.getFileName(),a=this.checkFileName(r,"bin");!0===a?(e.setNormal(),n.firmwareView.confirmUpgrade.show()):e.setError(a)}},"#firmware-upgrade-msg":{"ev_msg_ok":function(){"online"===o.modeFlag?o.startOnlineUpgrade():"manual"===o.modeFlag&&o.startLocalUpgrade()}},"#qs-upgrade-retry-btn":{"ev_button_click":function(){o.startOnlineUpgrade()}},".qs-upgrade-skip-btn":{"ev_button_click":function(){o.goToSummary()}},"#reconnect-msg":{"ev_msg_ok":function(e,r){var a=l.Deferred(),t=n.firmwareView.reconnectMsg;r.preventDefault(),t.disableButton("ok"),o.checkRouter({success:function(){a.resolve()},fail:function(){a.resolve()},error:function(){a.reject()}}),a.then(function(){t.close(),t.enableButton("ok"),localStorage&&localStorage.setItem("token",""),window.location.href="/"},function(){t.enableButton("ok")})}},"#firmware-auto-update":{"ev_view_change":function(e,r){"on"!=r.value||"auto"==o.timeType?a.autoUpgradeModel.submit():n.firmwareView.autoUpdateCheckMsg.show()}},"#auto-update-settings":{"ev_button_click":function(){i.moduleManager.get("navigatorController").goTo("timeSettings")}},"#auto-update-check-msg":{"ev_msg_ok":function(e,r){i.moduleManager.get("navigatorController").goTo("timeSettings")},"ev_msg_no":function(e,r){a.autoUpgradeModel.enable.setValue("off")}}})}},function(o,n,i,e,s,c){var t=0,u=null;return{wireType:"",timeType:"",modeFlag:"",rebootTime:12e4,queryLocalInterval:!1,queryLocalIntervalMax:!1,queryOnlineInterval:!1,checkDownloadInterval:!1,MODE:{"QUICK_SETUP":"qs","NETWORK_MAP":"networkMap"},setMode:function(e){u=e},getMode:function(){return u},setQsState:function(e){s.quickSetup.upgradeState=e},startCheckUpgrade:function(){n.firmwareView.checkUpgradesBtn.setTips(),n.firmwareView.checkUpgradesBtn.setNormal(),n.firmwareView.checkUpgradesBtn.loading(!0);var e=l.Deferred(),r=l.Deferred();l.Deferred();o.detectInternet(function(){e.resolve()},function(){o.showCheckError(l.su.CHAR.ERROR["10000139"])},function(){o.showCheckError(l.su.CHAR.ERROR["10000139"])}),l.when(e).then(function(){o.detectDevice(function(){r.resolve()},function(){o.showUpgradeError()},function(){o.showUpgradeError()})}),l.when(r).then(function(){i.onlineUpgradeModel.load({fail:function(){o.showCheckError(l.su.CHAR.ERROR["10000193"])},error:function(){o.showCheckError(l.su.CHAR.ERROR["10000193"])}})})},goToSummary:function(){s.quickSetup.submitQsWirelssData()},startOnlineUpgrade:function(){var r=o.getMode();r!==o.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.DOWNLOADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP);var a,e=l.Deferred(),t=l.Deferred();if(l(".qs-download-fail-icon").removeClass("upgrade"),n.firmwareQsView.qsFwUpgradeProgress.show(),n.firmwareQsView.qsFwUpgradeFail.hide(),n.firmwareQsView.qsFailNote.setText(l.su.CHAR.FIRMWARE.DOWNLOAD_FAIL),n.firmwareQsView.qsUpgradeRoad.setText(l.su.CHAR.FIRMWARE.TRY_AGAIN),n.firmwareQsView.qsUpgradeDownloadBtns.show(),n.firmwareQsView.qsUpgradeNextBtn.hide(),r===o.MODE.QUICK_SETUP)errorHandler=this.qsErrorHandler.bind(this),a=this.qsErrorHandler.bind(this);else if(r===o.MODE.NETWORK_MAP){errorHandler=s.main.showError,a=s.main.showError,l.su.moduleManager.get("networkMap").beforeDestroy()}else errorHandler=o.showCheckError,a=o.showOnlineUpgradeError;o.detectInternet(function(){e.resolve()},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])}),l.when(e).then(function(){o.detectDevice(function(){t.resolve()},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])})}),l.when(t).then(function(){i.onlineUpgradeModel.getProxy().upgrade({success:function(e){r===o.MODE.QUICK_SETUP&&o.setUpgradedValue(!0),o.detectDownloadStatus()},fail:function(e){a(l.su.CHAR.ERROR["10000194"])},error:function(){a(l.su.CHAR.ERROR["10000194"])}})})},qsErrorHandler:function(){this.setQsState("upgradeFailed"),n.firmwareQsView.qsFwUpgradeProgress.hide(),n.firmwareQsView.qsFwUpgradeFail.show()},startLocalUpgrade:function(){n.firmwareView.proBar.reset(),n.firmwareView.proBarTitle.setText(l.su.CHAR.FIRMWARE.UPLOADING),n.firmwareView.proBarTips.setText(l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),n.firmwareView.confirmUpgrade.hide(),n.firmwareView.progressbarWrap.show(),c.ajax.upload({proxy:"uploadFirmwareProxy",fileId:"manual-upgrade-file",timeout:72e4,success:function(e){n.firmwareView.confirmUpgrade.hide(),n.firmwareView.proBar.setValue(0),n.firmwareView.proBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){n.firmwareView.progressbarWrap.hide(),localStorage&&localStorage.setItem("token",""),o.getMode()==o.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==o.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()}})},fail:function(e){n.firmwareView.progressbarWrap.hide(),o.showUpgradeFailedMsg("err_form")},error:function(){n.firmwareView.progressbarWrap.hide(),o.showUpgradeFailedMsg("err_form")}})},detectInternet:function(r,a,t){c.ajax.request({proxy:"checkInternetProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},detectDevice:function(r,a,t){c.ajax.request({proxy:"checkDeviceProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},detectDownloadStatus:function(){var a=this.getMode();n.firmwareView.confirmUpgrade.hide(),clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=setInterval(function(){c.ajax.request({proxy:"checkDownloadStatusProxy",success:function(e){t=0;var r=parseInt(e.percent,10);a===o.MODE.QUICK_SETUP?n.firmwareQsView.qsFwUpgradeBar.setValue(r):s.main.setProBarValue(r),100===r&&(clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,o.detectOnlineUpgradeStatus())},fail:function(e){if(15===++t){if(t=0,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,s.main.hideProBar(),u===o.MODE.QUICK_SETUP)return o.setUpgradedValue(!1),void o.qsErrorHandler();var r=e.errorcode;if(r){var a=r.toString().replace(/^-/,"E");s.main.setUpgradeRetryContent(l.su.CHAR.ERROR[a])}s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()}},error:function(){if(15===++t){if(t=0,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,s.main.hideProBar(),u===o.MODE.QUICK_SETUP)return o.setUpgradedValue(!1),void o.qsErrorHandler();s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()}}})},1e3)},detectOnlineUpgradeStatus:function(){l(".qs-download-fail-icon").addClass("upgrade"),n.firmwareQsView.qsFailNote.setText(l.su.CHAR.FIRMWARE.UPGRADE_FAIL_NOTE),n.firmwareQsView.qsUpgradeRoad.setText(l.su.CHAR.FIRMWARE.UPGRADE_FAIL_ROAD),n.firmwareQsView.qsUpgradeDownloadBtns.hide(),n.firmwareQsView.qsUpgradeNextBtn.show();var e=o.getMode();e!==o.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.UPGRADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),n.firmwareQsView.qsFwUpgradeBar.reset(),n.firmwareQsView.qsFwUpgradeBar.setText(l.su.CHAR.FIRMWARE.UPGRADING),e===o.MODE.QUICK_SETUP?s.quickSetup.submitQsWirelssData({success:function(){n.firmwareQsView.qsFwUpgradeBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){localStorage&&localStorage.setItem("token",""),s.quickSetup.goTo("qsSummary")}})}}):s.main.setProBarAnimate(i.firmwareSetModel.upgradetime.getValue(),function r(){s.main.hideProBar(),localStorage&&localStorage.setItem("token",""),this.getMode()==this.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==this.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()},o)},detectLocalUpgradeStatus:function(){c.ajax.request({proxy:"checkUpgradeStatusProxy",success:function(e){clearTimeout(o.queryLocalIntervalMax);var r=parseInt(e.percent,10);n.firmwareView.proBar.setValue(r),100===r&&(clearInterval(o.queryLocalInterval),o.queryLocalInterval=null,n.firmwareView.progressbarWrap.hide(),o.startReboot(o.rebootTime,!0))}})},startReboot:function(e,r){s.main.startReboot(e,function(){localStorage&&localStorage.setItem("token",""),o.getMode()==o.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==o.wireType?window.location.href="/":n.firmwareView.reconnectMsg.show()},r?l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP:"")},checkFileName:function(e,r){return c.vtype.validate(e,{vtype:"string_file",extension:r})},showCheckError:function(e){n.firmwareView.upgradeOption.hide(),n.firmwareView.checkUpgradesBtn.show(),n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.checkUpgradesBtn.setError(e)},showOnlineUpgradeError:function(e){n.firmwareView.onlineUpgradeBtn.setError(e)},showUpgradeError:function(){n.firmwareView.checkUpgradesBtn.loading(!1),n.firmwareView.upgradeErrorMsg.show()},showUpgradeFailedMsg:function(e){switch(e){case"err_form":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000001"]);break;case"err_check":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000002"]);break;case"err_sizex":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000003"]);break;case"err_flash":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000004"]);break;case"err_reboot":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000005"]);break;case"err_other":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000006"]);break;case"err_failed":n.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["10000192"])}n.firmwareView.upgradeFailMsg.show()},failureRetry:function(){var r=this;i.onlineUpgradeModel.getProxy().upgrade({success:function(e){r.getMode()!==r.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.DOWNLOADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),r.detectDownloadStatus()},fail:function(e){r.showOnlineUpgradeError(l.su.CHAR.ERROR["10000191"])},error:function(){r.showOnlineUpgradeError(l.su.CHAR.ERROR["10000191"])}})},removeInterval:function(){clearInterval(o.queryLocalInterval),o.queryLocalInterval=null,clearInterval(o.queryOnlineInterval),o.queryOnlineInterval=null,clearInterval(o.checkDownloadInterval),o.checkDownloadInterval=null,n.firmwareView.proBar.stop()},beforeDestroy:function(){o.removeInterval(),c.time.off("on_time_change",o.onTimeChange)},setUpgradedValue:function(e){c.ajax.request({proxy:"firmwareProxy",method:"write",data:{upgraded:e}})},checkRouter:function(e){if(e)var r=e.success,a=e.fail,t=e.error;c.ajax.request({proxy:"checkRouterProxy",success:function(e){r&&r(e)},fail:function(e){a&&a(e)},error:function(e){t&&t(e)}})},onTimeChange:function(e,r){var a=c.time.getHour24(),t=c.time.format(r,"yyyy-MM-dd HH:mm:ss",a);n.firmwareView.currentTime.setValue(t)}}})}(jQuery);