!function(d){d.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl","vercodeModel","resetPwdModel"],stores:[],views:["localLoginView"],deps:["login","main"],listeners:{"ev_on_launch":function(e,n,o,t,i,l,a){o.localLoginView.noInternetTips.hide(),a.ajax.request({proxy:"keyProxy",success:function(e){var o=e;o&&o.password&&(n.encryptKey=o.password)}}),l.login.supportCloud()?(o.localLoginView.switchToTp.show(),o.localLoginView.mainPanel.setTitle(d.su.CHAR.LOGIN.LOCAL_LOGIN)):(o.localLoginView.switchToTp.hide(),o.localLoginView.mainPanel.setTitle(d.su.CHAR.LOGIN.LOGIN)),a.ajax.request({proxy:"sysmodeLoginProxy",data:{"operation":"read"},success:function(e){"ap"===e.mode?o.localLoginView.switchToTp.hide():o.localLoginView.switchToTp.show()}})}},init:function(t,i,n,e,o,l){this.control({"#local-login-pwd":{"keyup":function(e){13==e.keyCode&&t.doLogin()}},"#local-login-button":{"ev_button_click":function(){t.doLogin()}},".local-login-switch-to-tp":{"click":function(e){l.ajax.request({proxy:"loginCheckInternetProxy",method:"read",success:function(e){o.login.goToChildModule("tpLogin")},fail:function(){i.localLoginView.noInternetTips.show(),i.localLoginView.noInternetTips.setText(d.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)},error:function(){i.localLoginView.noInternetTips.show(),i.localLoginView.noInternetTips.setText(d.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)}})}},".local-login-forget-pwd":{"mousedown":function(){t.forgetPasswordHandler()}},"#send-code-btn":{"ev_button_click":function(){i.localLoginView.sendCodeFailedNote.hide(),l.ajax.request({data:{operation:"read"},proxy:"sendCodeProxy",success:function(e){t.enableConfirm=!0,i.localLoginView.sendCodeBtn.disable(),i.localLoginView.sendCodeBtn.setText(t.receiveCodeTimeCount+d.su.CHAR.LOGIN.SEC),clearInterval(t.countDownTimer),t.countDownTimer=setInterval(function(){0<t.receiveCodeTimeCount?(t.receiveCodeTimeCount--,i.localLoginView.sendCodeBtn.setText(t.receiveCodeTimeCount+d.su.CHAR.LOGIN.SEC)):(clearInterval(t.countDownTimer),t.receiveCodeTimeCount=60,i.localLoginView.sendCodeBtn.enable(),i.localLoginView.sendCodeBtn.setText(d.su.CHAR.LOGIN.SEND))},1e3)},fail:function(){i.localLoginView.sendCodeFailedNote.show()}})}},"#confirm-code-btn":{"ev_button_click":function(){t.enableConfirm&&(i.localLoginView.sendCodeFailedNote.hide(),n.vercodeModel.submit({success:function(e){t.vercode=e.vercode,i.localLoginView.forgetPasswordSendCodeMsg.hide(),n.resetPwdModel.password.setValue(),n.resetPwdModel.confirm.setValue(),i.localLoginView.resetPasswordMsg.show()},fail:function(e,o){n.vercodeModel.vercode.setError(),i.localLoginView.confirmCodeOverlimitNote.setText(d.su.CHAR.ERROR[o]),i.localLoginView.confirmCodeOverlimitMsg.show()},error:function(){n.vercodeModel.vercode.setError()}}))}},"#reset-pwd-btn":{"ev_button_click":function(){if(n.resetPwdModel.validate()){if(n.resetPwdModel.password.getValue()!=n.resetPwdModel.confirm.getValue())return void n.resetPwdModel.confirm.setError(d.su.CHAR.ERROR["00000080"]);var e=n.resetPwdModel.password.doEncrypt(t.encryptKey);l.ajax.request({proxy:"forgetPasswordProxy",data:{operation:"write",password:e,confirm:!0,vercode:t.vercode},success:function(e){i.localLoginView.resetPasswordMsg.hide()}})}}},"#send-code-content":{"ev_view_change":function(e,o){if("value"===o.type){var n=o.value;t.enableConfirm&&n?i.localLoginView.confirmCodeBtn.enable():i.localLoginView.confirmCodeBtn.disable()}}},".find-local-pwd-jump-label":{"click":function(){t.queryRecoveryPasswordMethod().then(function(e){e?o.login.goToChildModule("localPwdRecovery"):i.localLoginView.noRecoveryMethodMsg.show()})}},"#user-conflict-prompt":{"ev_msg_ok":function(){var e=n.localLoginControl.password.doEncrypt(t.encryptKey);n.localLogin.password.setValue(e),n.localLogin.login({data:{operation:"login",confirm:!0},success:t.loginSuccessDealer,fail:t.loginFailDealer})}}})}},function(n,r,c,e,a,t){return{enableConfirm:!1,receiveCodeTimeCount:60,countDownTimer:null,encryptKey:null,vercode:"",doLogin:function(){if(c.localLoginControl.validate()){var o=c.localLoginControl.password.getValue(),e=c.localLoginControl.password.doEncrypt(n.encryptKey);c.localLogin.password.setValue(e),r.localLoginView.localLoginBtn.loading(!0),t.ajax.request({proxy:"authProxy",success:function(e){d.su.encryptor.setRSAKey(e.key[0],e.key[1]),d.su.encryptor.setSeq(e.seq),d.su.encryptor.genAESKey(),d.su.encryptor.setHash("admin",o),d.encrypt.encryptManager.recordEncryptor(),c.localLogin.login({preventFailEvent:!0,success:n.loginSuccessDealer,fail:n.loginFailDealer})}})}},loginSuccessDealer:function(e,o){r.localLoginView.localLoginBtn.loading(!1);var n,t,i,l=e.stok||(n="12345",t=top.location.href,0<=(i=t.indexOf("stok="))&&(n=t.substring(i+5)),n);localStorage&&(a.main.setToken(l),a.main.reload())},loginFailDealer:function(e,o){r.localLoginView.localLoginBtn.loading(!1);var n=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&n){var t=String(e.data.errorcode).replace(/^-/,"E");c.localLoginControl.password.setErrorHtml(d.su.CHAR.ERROR[t])}else if(o)switch(o){case"user conflict":e.data.logined_user;r.localLoginView.userConflictMsgContent.setText(d.su.CHAR.LOGIN.USER_CONFLICT_MSG),r.localLoginView.userConflictMsg.show();break;case"login failed":var i=e.data.failureCount,l=(s=e.data.attemptsAllowed)+i;if(0===s){var a=d.su.CHAR.ERROR["00000089"].replace("%num",l);r.localLoginView.maxAttemptsMsgContent.setText(a),r.localLoginView.maxAttemptsMsg.show()}else if(s<=i){a=(a=d.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",i)).replace("%num2",s),r.localLoginView.leftAttemptsMsgContent.setText(a),r.localLoginView.leftAttemptsMsg.show()}else r.localLoginView.leftAttemptsMsgContent.setText(d.su.CHAR.LOGIN.LOGIN_FAILED),r.localLoginView.leftAttemptsMsg.show();break;case"exceeded max attempts":var s;i=e.data.failureCount,l=(s=e.data.attemptsAllowed)+i,a=d.su.CHAR.ERROR["00000089"].replace("%num",l);r.localLoginView.maxAttemptsMsgContent.setText(a),r.localLoginView.maxAttemptsMsg.show()}},queryRecoveryPasswordMethod:function(){var e=d.Deferred();return e.resolve(!0),e.promise()},forgetPasswordHandler:function(){t.ajax.request({proxy:"forgetPasswordProxy",success:function(e){e&&(e.enable_rec?(r.localLoginView.sendCodeFailedNote.hide(),c.vercodeModel.vercode.setNormal(),c.vercodeModel.vercode.setValue(),r.localLoginView.confirmCodeBtn.disable(),r.localLoginView.forgetPasswordSendCodeMsg.show()):r.localLoginView.forgetPasswordMsg.show(),clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,r.localLoginView.sendCodeBtn.enable(),r.localLoginView.sendCodeBtn.setText(d.su.CHAR.LOGIN.SEND))}})}}})}(jQuery);