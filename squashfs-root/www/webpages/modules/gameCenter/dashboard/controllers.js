!function(b){b.su.moduleManager.define("dashboard",{deps:["speedTest","navigatorController"],services:["ajax","timer","moduleLoader","moduleManager"],models:["statusAll","internetSpeedModel"],stores:["connectedClientsStore","usbStorageStore","timePeriodStore"],views:["dashboardView"],listeners:{"ev_on_launch":function(e,t,a,n,i,o,s){this.unRegisterAutoSaveData([i.connectedClientsStore]),t.initPerformance(),t.initSpeedtest(),t.initClients(),s.timer.setInterval(t,function(){n.statusAll.load()},2e3,!0)}},init:function(i,e,t,o,a,s){this.configViews({id:"dashboardView",items:[{id:"internet-conn-note",title:b.su.CHAR.NETWORK_MAP.TRY_FOLLOW,items:[{text:b.su.CHAR.NETWORK_MAP.TRY_1},{text:b.su.CHAR.NETWORK_MAP.TRY_2},{text:b.su.CHAR.NETWORK_MAP.TRY_3},{text:b.su.CHAR.NETWORK_MAP.TRY_4}]},{id:"connected-clients-grid",configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty"},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var a="",n="",i="";switch(e=e.toLowerCase()){case"pc":a="icon-pc";break;case"phone":a="icon-phone";break;case"pad":a="icon-pad";break;case"other":a="icon-other";break;default:a="icon-"+e}return t.isGaming&&(i='<span class="gaming-tag"></span>'),n+='<div class="device-type-container widget-container">',n+='<span class="icon '+a+' ">'+i+"</span>",null!=t.enableInternet&&(n+='<span class="text">'+(t.enableInternet?"":b.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),n+="</div>",n+='<div class="device-info-container widget-container">',n+='<div class="mac">'+t.mac+"</div>",n+='<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>",n+="</div>"}},{text:b.su.CHAR.DASHBOARD.TYPE,width:"16%",dataIndex:"deviceType",cls:"s-hide",renderer:function(e,t){var a="",n="",i="";switch(e=e.toLowerCase()){case"pc":a="icon-pc";break;case"phone":a="icon-phone";break;case"pad":a="icon-pad";break;case"other":a="icon-other";break;default:a="icon-"+e}return t.isGaming&&(i='<span class="gaming-tag"></span>'),n+='<div class="device-type-container widget-container">',n+='<span class="icon '+a+' ">'+i+"</span>",null!=t.enableInternet&&(n+='<span class="text">'+(t.enableInternet?"":b.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),n+="</div>"}},{text:b.su.CHAR.DASHBOARD.INFORMATION,dataIndex:"deviceName",width:"25%",cls:"s-hide",renderer:function(e,t){var a="";if("object"===b.type(t)){var n=t.deviceName;a+='<div class="device-info-container widget-container">',a+='<div class="name" title="'+n+'">'+n+"</div>",a+='<div class="mac">'+t.mac+"</div>",a+='<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>",a+="</div>"}return a}},{text:b.su.CHAR.DASHBOARD.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var a,n,i="",o=function(e){var t;return t=(e=parseInt(e,10))/1024<1?(0!==e&&(e=(e/1024).toFixed(2)),b.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(e/1024<1e3?e=(e/1024).toFixed(1):e/=1024,b.su.CHAR.DASHBOARD.KBPS):(e=(e/1024/1024).toFixed(1),b.su.CHAR.DASHBOARD.MBPS),{speed:e,unit:t}};return"object"===b.type(t)&&(a=o(t.downloadSpeed),i+='<div class="speed-upload-container widget-container">',i+='<span class="icon"></span>',i+='<span class="text">'+(n=o(t.uploadSpeed)).speed+"</span>",i+='<span class="unit">'+n.unit+"</span>",i+="</div>",i+='<div class="speed-download-container widget-container">',i+='<span class="icon"></span>',i+='<span class="text">'+a.speed+"</span>",i+='<span class="unit">'+a.unit+"</span>",i+="</div>"),i}},{text:b.su.CHAR.DASHBOARD.DEVICE_PRIORITY,dataIndex:"enablePriority",xtype:"customWidget",cls:"status connected-clients-grid-priority-td",widgetName:"switch",settings:{trueValue:!0,falseValue:!1}},{text:b.su.CHAR.DASHBOARD.TIMING,dataIndex:"timePeriod",xtype:"customWidget",width:90,cls:"s-2-col",widgetName:"combobox",settings:{noneSelectedText:"",items:o.timePeriodStore.getData()},renderer:function(e,t){return!t.enablePriority&&"---"}}]}}]}),this.control({"#speed-test-mini-panel":{"click":function(){b("#speed-test-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").toggle(b("#speed-test-mini-panel").hasClass("selected")),b("#performance-panel").hide(),b("#usb-panel").hide(),e.dashboardView.internetSpeedUsage.resize()}},"#performance-mini-panel":{"click":function(){b("#performance-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").hide(),b("#performance-panel").toggle(b("#performance-mini-panel").hasClass("selected")),b("#usb-panel").hide(),e.dashboardView.cpuLoad.resize(),e.dashboardView.memoryUsage.resize()}},"#usb-mini-panel":{"click":function(){o.usbStorageStore.getData()&&o.usbStorageStore.getData().length&&(b("#usb-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").hide(),b("#performance-panel").hide(),b("#usb-panel").toggle(b("#usb-mini-panel").hasClass("selected")))}},"#map-router-usb-button":{"ev_button_click":function(e){a.navigatorController.goTo("storageSharing")}}}),this.listen({"models.statusAll":{"ev_loaded":function(e,t){i.setStorage(t),i.setPerformance(t)}},"stores.connectedClientsStore":{"ev_data_change":function(e,t,a){if("enablePriority"===a.getName()&&t.value!==t.oldValue){var n=s.moduleManager.get("bandwidth");n.hasConfigured()?(o.connectedClientsStore.abort(),o.connectedClientsStore.sync({success:function(e){o.connectedClientsStore.loadData(e,!0)}})):t.value&&(i.stopGetClients(),n.showBandwithMsg())}"timePeriod"==a.getName()&&t.value!=t.oldValue&&(o.connectedClientsStore.abort(),o.connectedClientsStore.sync())}}})}},function(c,u,n,a,e,i){var o,s=null,p=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),S=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),r=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),d=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),h=function(e,t){e=e||2e3,t=t||7;for(var a=new Date,n=[];t--;)n.unshift(i(a)),a=new Date(a-e);function i(e){var t="";return t+=("0"+e.getHours()).slice(-2),t+=":",t+=("0"+e.getMinutes()).slice(-2),t+=":",t+=("0"+e.getSeconds()).slice(-2)}return n};return{speedRequestInterval:2e3,setStorage:function(e){var i={PB:b.su.CHAR.UNIT.PB,TB:b.su.CHAR.UNIT.TB,GB:b.su.CHAR.UNIT.GB,MB:b.su.CHAR.UNIT.MB,KB:b.su.CHAR.UNIT.KB,B:b.su.CHAR.UNIT.B};function o(e){return e&&e.toUpperCase()}e.usbStorages.length?(u.dashboardView.noUSBTips.hide(),u.dashboardView.USBFieldset.show(),b.each(e.usbStorages,function(e,t){var a=b.su.capacityToNum(t.available+i[o(t.availableUnit)]),n=b.su.capacityToNum(t.capacity+i[o(t.capacityUnit)]);t.usageRate=a/n*100}),b("#usb-panel").toggleClass("single-column",1===e.usbStorages.length),a.usbStorageStore.loadData(e.usbStorages,!0)):(u.dashboardView.noUSBTips.show(),u.dashboardView.USBFieldset.hide(),b("#usb-mini-panel").removeClass("selected"),b("#usb-panel").hide())},initSpeedtest:function(){u.dashboardView.internetSpeedUsage.setOption(c.calculateInternetSpeedOption()),u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),u.dashboardView.internetSpeedUpload.setValue("0 "+b.su.CHAR.DASHBOARD.KBPS),u.dashboardView.internetSpeedDownload.setValue("0 "+b.su.CHAR.DASHBOARD.KBPS),i.timer.setInterval(c,function(){i.ajax.request({proxy:"internetStatusProxy",success:function(e){"CONNECTED"===e.internetStatus.toUpperCase()?(c.getInternetSpeed({success:function(e){c.setInternetSpeed(e)}}),u.dashboardView.speedTestPanel.show(),u.dashboardView.noInternetFieldset.hide()):(u.dashboardView.speedTestPanel.hide(),u.dashboardView.noInternetFieldset.show(),u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS))}})},c.speedRequestInterval,!0)},getInternetSpeed:function(e){if(e)var t=e.success,a=e.fail;n.internetSpeedModel.load({success:function(){t&&t(n.internetSpeedModel.getData())},fail:function(e){a&&a(e)}})},setInternetSpeed:function(e){var t=this.separateSpeed(e.upSpeed),a=this.separateSpeed(e.downSpeed);u.dashboardView.speedTestMiniPanel.setField("uploadSpeed",t.value),u.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",t.unit),u.dashboardView.speedTestMiniPanel.setField("downloadSpeed",a.value),u.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",a.unit),u.dashboardView.internetSpeedUpload.setValue(t.value+" "+t.unit),u.dashboardView.internetSpeedDownload.setValue(a.value+" "+a.unit);var n=h(c.speedRequestInterval,26);p.shift(),p.push(e.upSpeed/1024),S.shift(),S.push(e.downSpeed/1024);var i,o,s,r,d=Math.max.apply(this,p.concat(S));function l(e){var t,a,n,i=parseInt(e,10).toString().length,o=Math.max(i-2,0);return t=e,a=o,n=3*Math.pow(10,a),Math.ceil(t/n)*n}s=1024<=d?(d/=1024,i=b.map(p,function(e){return e/1024}),o=b.map(S,function(e){return e/1024}),r=b.su.CHAR.DASHBOARD.MBPS,l(d)):(i=p,o=S,r=b.su.CHAR.DASHBOARD.KBPS,Math.max(l(d),120)),u.dashboardView.internetSpeedUsage.setOption({xAxis:[{data:n}],yAxis:[{max:s,interval:s/3,axisLabel:{formatter:function(e,t){return s/3*t+r}}}],series:[{data:i},{data:o}]})},calculateInternetSpeedOption:function(e){return e=b.extend({title:"",color:"#ffcd08",name:"internetSpeed"},e),{title:{show:!1},grid:{top:10,right:30,left:72,bottom:40,containLabel:!1},xAxis:[{name:"",type:"category",axisLine:{show:!1},axisLabel:{show:!0,interval:4,margin:20,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12}},axisTick:{show:!1,alignWithLabel:!0},splitLine:{show:!0,interval:4,lineStyle:{color:"#4a3a3a"}},boundaryGap:!1,data:h(c.speedRequestInterval,26)}],yAxis:[{max:120,min:0,interval:40,offset:40,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{color:"#4a3a3a"}},axisLabel:{show:!0,align:"left",margin:24,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+b.su.CHAR.DASHBOARD.KBPS}}}],series:[{name:"upload",type:"line",smooth:!0,symbol:"none",zIndex:2,itemStyle:{normal:{color:"rgb(236,154,0)",borderColor:"rgb(236,154,0)"}},areaStyle:{normal:{color:"rgba(236,154,0,0.4)"}},lineStyle:{width:1},data:e.data},{name:"download",type:"line",smooth:!0,symbol:"none",zIndex:1,itemStyle:{normal:{color:"rgb(175,0,0)",borderColor:"rgb(175,0,0)"}},areaStyle:{normal:{color:"rgba(175,0,0,0.4)"}},lineStyle:{width:1},data:e.data}]}},initPerformance:function(){u.dashboardView.cpuLoad.setOption(c.calculateLineOption({title:b.su.CHAR.DASHBOARD.CPU_LOAD,color:"#ffcd08",tooltip:{backgroundColor:"rgba(236,154,0,0.4)"},areaColor:"rgba(255, 205, 8, 0.5)",name:b.su.CHAR.DASHBOARD.CPU_CORE_NUMBER+":"})),u.dashboardView.memoryUsage.setOption(c.calculateLineOption({title:b.su.CHAR.DASHBOARD.MEMORY_USAGE,color:"#ff0000",tooltip:{backgroundColor:"rgba(255, 0, 0, 0.8)"},areaColor:"rgba(175,0,0,0.4)"}))},setPerformance:function(e){var t=e.cpuUsage,a=e.memUsage,n=h(2e3,7);r.shift(),r.push(t),u.dashboardView.cpuLoad.setOption({xAxis:[{data:n}],series:{data:r}}),d.shift(),d.push(a),u.dashboardView.memoryUsage.setOption({xAxis:[{data:n}],series:{data:d}})},calculateLineOption:function(s){return{title:{show:!1,text:(s=b.extend({title:"",color:"#ffcd08",name:"",areaColor:"rgba(255, 205, 8, 0.5)"},s)).title,textStyle:{fontSize:13},left:20},grid:{top:10,right:0,left:40,bottom:10},tooltip:b.extend({show:!0,formatter:"{c}%",textStyle:{color:"#fff",fontSize:12,lineHeight:14,fontFamily:"Arial, Sans-Serif, Geneva, Verdana"},padding:[2.6,6],position:function(e,t,a,n,i){var o="";return o+="<span>"+t.value+"%</span>",o+='<span style="display:block;position:absolute;left:'+(i.contentSize[0]/2-3+"px")+";bottom:-6px;border-top:6px solid "+s.tooltip.backgroundColor+';border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:none;background-color:transparent;width:0;height:0;line-height:14px;"></span>',b(a).html(o),[e[0]-18.5,e[1]-40]}},s.tooltip),xAxis:[{name:"",nameLocation:"middle",nameTextStyle:{color:"#000"},type:"category",axisLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:h(2e3,7)}],yAxis:[{max:100,min:0,interval:20,offset:32,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1,lineStyle:{type:"dashed"}},axisLabel:{show:!0,align:"left",textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+"%"}}}],series:[{name:"RX",type:"line",smooth:!0,symbol:"emptyCircle",symbolSize:6,showAllSymbol:!0,legendHoverLink:!1,itemStyle:{normal:{color:s.color,borderColor:s.color}},areaStyle:{normal:{color:s.areaColor}},lineStyle:{width:1},data:s.data}]}},initClients:function(){i.moduleLoader.load({module:"dashboard"},{module:"bandwidth"},u.dashboardView.qosBandwidthLoader,function(){var e=i.moduleManager.get("bandwidth");e.on("ev_qos_saved",function(e){a.connectedClientsStore.abort(),a.connectedClientsStore.sync({success:function(e){a.connectedClientsStore.loadData(e,!0),t()}})}),e.on("ev_qos_save_close",function(e){a.connectedClientsStore.reset(),t()}),e.on("ev_qos_save_cancel",function(e){a.connectedClientsStore.reset(),t()})});var t=function(){clearInterval(s),s=setInterval(function(){a.connectedClientsStore.load({data:{operation:"loadSpeed"}})},1e4)},e={data:{operation:"loadDevice"},success:function(e){a.connectedClientsStore.load({data:{operation:"loadSpeed"}})}};a.connectedClientsStore.load(e),t()},stopGetClients:function(){clearInterval(s)},getClients:function(){i.ajax.request({proxy:"clientStatusProxy",success:function(e){o=e,a.connectedClientsStore.load({data:{operation:"loadSpeed"}})}})},getAccessControlMode:function(e){var t;e&&(t=e.success),n.accessControl.load({success:function(e){t&&t(n.accessControl.getData())}})},blockDevice:function(e){i.ajax.request({proxy:"blockClientProxy",data:{mac:e},success:function(e){a.connectedClientsStore.load({operation:"loadDevice"})}})},beforeDestroy:function(){clearInterval(s)},getIPaddr:function(e){if(o)for(var t in o)for(var a=0,n=o[t].length;a<n;a++)if(o[t][a].macaddr==e)return o[t][a].ipaddr||"";return""},separateSpeed:function(e){var t={},a=e;return t.unit=a/1024<1?(t.value=0===a?0:a/1024,b.su.CHAR.DASHBOARD.KBPS):a/1024/1024<1?(t.value=a/1024,b.su.CHAR.DASHBOARD.KBPS):(t.value=a/1024/1024,b.su.CHAR.DASHBOARD.MBPS),t.value=parseFloat(t.value.toFixed(2)),t}}})}(jQuery);